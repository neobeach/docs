<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Adding favicon -->
    

    <!-- Adding meta -->
    
    
    <meta name="author" content="Glenn de Haan" />
    
    <meta name="description" content="Base web framework based on the popular ExpressJS package" />
    
    

    <!-- Adding external script-->
    

    <!-- Adding external style-->
    

    <!-- Adding scripts-->
    

    <!-- Adding style-->
    

    <!-- Adding overlay script-->
    

    <!-- Adding overlay style-->
    


    <title>
      Server.js
    </title>

    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/third-party/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/third-party/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/reset.css">
    <link type="text/css" rel="stylesheet" href="styles/clean-jsdoc-theme-base.css">
    <link type="text/css" rel="stylesheet" href="styles/clean-jsdoc-theme-dark.css">
    
    <svg aria-hidden="true" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
    style="display:none">
    <defs>
        <symbol id="copy-icon" viewbox="0 0 488.3 488.3">
            <g>
                <path
                    d="M314.25,85.4h-227c-21.3,0-38.6,17.3-38.6,38.6v325.7c0,21.3,17.3,38.6,38.6,38.6h227c21.3,0,38.6-17.3,38.6-38.6V124    C352.75,102.7,335.45,85.4,314.25,85.4z M325.75,449.6c0,6.4-5.2,11.6-11.6,11.6h-227c-6.4,0-11.6-5.2-11.6-11.6V124    c0-6.4,5.2-11.6,11.6-11.6h227c6.4,0,11.6,5.2,11.6,11.6V449.6z" />
                <path
                    d="M401.05,0h-227c-21.3,0-38.6,17.3-38.6,38.6c0,7.5,6,13.5,13.5,13.5s13.5-6,13.5-13.5c0-6.4,5.2-11.6,11.6-11.6h227    c6.4,0,11.6,5.2,11.6,11.6v325.7c0,6.4-5.2,11.6-11.6,11.6c-7.5,0-13.5,6-13.5,13.5s6,13.5,13.5,13.5c21.3,0,38.6-17.3,38.6-38.6    V38.6C439.65,17.3,422.35,0,401.05,0z" />
            </g>
        </symbol>
        <symbol id='search-icon' viewBox="0 0 512 512">
            <g>
                <g>
                    <path
                        d="M225.474,0C101.151,0,0,101.151,0,225.474c0,124.33,101.151,225.474,225.474,225.474    c124.33,0,225.474-101.144,225.474-225.474C450.948,101.151,349.804,0,225.474,0z M225.474,409.323    c-101.373,0-183.848-82.475-183.848-183.848S124.101,41.626,225.474,41.626s183.848,82.475,183.848,183.848    S326.847,409.323,225.474,409.323z" />
                </g>
            </g>
            <g>
                <g>
                    <path
                        d="M505.902,476.472L386.574,357.144c-8.131-8.131-21.299-8.131-29.43,0c-8.131,8.124-8.131,21.306,0,29.43l119.328,119.328    c4.065,4.065,9.387,6.098,14.715,6.098c5.321,0,10.649-2.033,14.715-6.098C514.033,497.778,514.033,484.596,505.902,476.472z" />
                </g>
            </g>
        </symbol>
        <symbol id="down-icon" viewBox="0 0 16 16">
            <path 
                fill-rule="evenodd" 
                clip-rule="evenodd" 
                d="M12.7803 6.21967C13.0732 6.51256 13.0732 6.98744 12.7803 7.28033L8.53033 11.5303C8.23744 11.8232 7.76256 11.8232 7.46967 11.5303L3.21967 7.28033C2.92678 6.98744 2.92678 6.51256 3.21967 6.21967C3.51256 5.92678 3.98744 5.92678 4.28033 6.21967L8 9.93934L11.7197 6.21967C12.0126 5.92678 12.4874 5.92678 12.7803 6.21967Z"
            >
            </path>
        </symbol>
    </defs>
</svg>
  </head>

  <body>

    <nav class="navbar" id="navbar">
      <div class="navbar-heading" id="navbar-heading"><a href="index.html"><h2 class="navbar-heading-text">@neobeach/core</h2></a></div><div class="search-box" id="search-box"><div class="search-box-input-container"><input class="search-box-input" type="text" placeholder="Search..." id="search-box-input" /><svg class="search-icon" alt="search-icon"><use xlink:href="#search-icon"></use></svg></div><div class="search-item-container" id="search-item-container"><ul class="search-item-ul" id="search-item-ul"></ul></div></div><div class="sidebar-main-content" id="sidebar-main-content"><ul><li class="menu-li"><a href='https://github.com/neobeach/core' class=' menu-link' id='' target='_blank'>GitHub</a></li><li class="menu-li"><a href='https://npmjs.com/@neobeach/core' class=' menu-link' id='' target='_blank'>NPM</a></li></ul><div class="accordion collapsed" id="8361750" > <h3 class="accordion-heading">Modules<svg><use xlink:href="#down-icon"></use></svg></h3><ul class="accordion-content"><li class="accordion-list" id=""><a href="module-Config.html">Config</a></li><li class="accordion-list" id=""><a href="module-Logger.html">Logger</a></li><li class="accordion-list" id=""><a href="module-Runtime.html">Runtime</a></li></ul> </div><div class="accordion collapsed" id="4855158" > <h3 class="accordion-heading">Classes<svg><use xlink:href="#down-icon"></use></svg></h3><ul class="accordion-content"><li class="accordion collapsed child" id=5176491><div class="accordion-heading child"><a href="Controller.html">Controller</a><svg><use xlink:href="#down-icon"></use></svg></div><ul class='methods accordion-content'><li data-type='method'><a href="Controller.html#copy">copy</a></li><li data-type='method'><a href="Controller.html#delete">delete</a></li><li data-type='method'><a href="Controller.html#get">get</a></li><li data-type='method'><a href="Controller.html#head">head</a></li><li data-type='method'><a href="Controller.html#lock">lock</a></li><li data-type='method'><a href="Controller.html#options">options</a></li><li data-type='method'><a href="Controller.html#patch">patch</a></li><li data-type='method'><a href="Controller.html#post">post</a></li><li data-type='method'><a href="Controller.html#purge">purge</a></li><li data-type='method'><a href="Controller.html#put">put</a></li><li data-type='method'><a href="Controller.html#unlock">unlock</a></li></ul></li><li class="accordion collapsed child" id=167420><div class="accordion-heading child"><a href="Router.html">Router</a><svg><use xlink:href="#down-icon"></use></svg></div><ul class='methods accordion-content'><li data-type='method'><a href="Router.html#add">add</a></li></ul></li><li class="accordion collapsed child" id=6109515><div class="accordion-heading child"><a href="Server.html">Server</a><svg><use xlink:href="#down-icon"></use></svg></div><ul class='methods accordion-content'><li data-type='method'><a href="Server.html#includeDefaultBodyParsers">includeDefaultBodyParsers</a></li><li data-type='method'><a href="Server.html#includeDefaultCompression">includeDefaultCompression</a></li><li data-type='method'><a href="Server.html#includeDefaultCorsHeaders">includeDefaultCorsHeaders</a></li><li data-type='method'><a href="Server.html#includeDefaultSecurityHeaders">includeDefaultSecurityHeaders</a></li><li data-type='method'><a href="Server.html#loadMiddlewares">loadMiddlewares</a></li><li data-type='method'><a href="Server.html#loadRemixFramework">loadRemixFramework</a></li><li data-type='method'><a href="Server.html#loadRouters">loadRouters</a></li><li data-type='method'><a href="Server.html#run">run</a></li></ul></li></ul> </div><div class="accordion collapsed" id="298566" > <h3 class="accordion-heading">Global<svg><use xlink:href="#down-icon"></use></svg></h3><ul class="accordion-content"><li class="accordion-list" id=""><a href="global.html#Logger">Logger</a></li></ul> </div>
      

    </nav>
    <div class="navbar-ham" id="navbar-ham">
      <div>
        <div class="first"></div>
        <div class="second"></div>
        <div class="third"></div>
      </div>
    </div>

    <div id="main" class="main-content">
      
      <h1 id='page-title' class="page-title">
        Server.js
      </h1>
      

      



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Import vendor modules
 * @ignore
 */
const os = require('os');
const express = require('express');

/**
 * Import own modules
 * @ignore
 */
const Logger = require('./Logger');
const Config = require('./Config');
const Router = require('./Router');
const Controller = require('./Controller');

class Server {
    /**
     * Setup an internal express app
     *
     * @access private
     * @since 1.0.0
     * @author Glenn de Haan
     * @copyright MIT
     *
     * @type {Express}
     */
    #app = express();

    /**
     * Internal bind hostname reference for Express
     *
     * @access private
     * @since 1.0.0
     * @author Glenn de Haan
     * @copyright MIT
     *
     * @type {string}
     */
    #host;

    /**
     * Internal bind port reference for Express
     *
     * @access private
     * @since 1.0.0
     * @author Glenn de Haan
     * @copyright MIT
     *
     * @type {number}
     */
    #port;

    /**
     * Server class
     *
     * @class Server
     * @access public
     * @since 1.0.0
     * @author Glenn de Haan
     * @copyright MIT
     *
     * @see https://www.npmjs.com/package/express
     *
     * @example
     * const {Runtime, Server} = require('@neobeach/core');
     * const Api = require('./routers/Api');
     *
     * const server = new Server();
     *
     * Runtime(() => {
     *     server.includeDefaultBodyParsers();
     *     server.loadRouters([Api]);
     *     server.run();
     * });
     */
    constructor() {
        // Set the host and port
        this.#host = Config.application.host;
        this.#port = Config.application.port;

        // Set the Express app to allow proxy's
        this.#app.enable('trust proxy');

        // Disable powered by header for security reasons
        this.#app.disable('x-powered-by');

        // Handle Google Cloud Loadbalancer requests (If the app try's to redirect from /)
        this.#app.use((req, res, next) => {
            if (req.get('User-Agent') === 'GoogleHC/1.0') {
                return res.send('Hello Google');
            }

            next();
        });

        // Expose library headers
        this.#app.use((req, res, next) => {
            const packageInformation = require(__dirname + '/../package.json');
            res.set('X-Neo-Beach', 'true');
            res.set('X-Neo-Beach-Core', packageInformation.version);

            next();
        });

        // Expose a health check
        this.#app.use((req, res, next) => {
            if(req.originalUrl === '/_health') {
                const packageInformation = require(__dirname + '/../package.json');

                res.json({
                    status: 'UP',
                    host: os.hostname(),
                    core: packageInformation.version,
                    load: process.cpuUsage(),
                    mem: process.memoryUsage(),
                    uptime: process.uptime()
                });

                return;
            }

            next();
        });
    }

    /**
     * Starts the Express server
     *
     * @access public
     * @since 1.0.0
     * @author Glenn de Haan
     * @copyright MIT
     *
     * @returns {function}
     *
     * @example
     * const {Runtime, Server} = require('@neobeach/core');
     * const Api = require('./routers/Api');
     *
     * const server = new Server();
     *
     * Runtime(() => {
     *     server.run();
     * });
     */
    run() {
        return this.#app.listen(this.#port, this.#host, () => {
            Logger.info(`[SERVER] Service started with success! App running at: ${this.#host}:${this.#port}`)
        });
    }

    /**
     * Load global middlewares into the Express app
     *
     * @access public
     * @since 1.0.0
     * @author Glenn de Haan
     * @copyright MIT
     *
     * @see http://expressjs.com/en/guide/writing-middleware.html
     *
     * @param {array.&lt;function(*, *, *)>} middlewares - An array with Express middleware functions
     *
     * @example
     * const {Runtime, Server} = require('@neobeach/core');
     *
     * const server = new Server();
     *
     * Runtime(() => {
     *    server.loadMiddlewares([
     *        (req, res, next) => {
     *            // Execute custom code here
     *            next();
     *        }
     *    ]);
     *    server.run();
     * });
     */
    loadMiddlewares(middlewares) {
        middlewares.forEach(mw => {
            this.#app.use(mw);
        });

        Logger.info(`[SERVER] Loaded ${middlewares.length} global middleware(s)`);
    }

    /**
     * Load routers into the Express app
     *
     * @access public
     * @since 1.0.0
     * @author Glenn de Haan
     * @copyright MIT
     *
     * @param {array} routers - An array with Routers
     *
     * @example
     * const {Runtime, Server} = require('@neobeach/core');
     * const Api = require('./routers/Api');
     *
     * const server = new Server();
     *
     * Runtime(() => {
     *     server.loadRouters([Api]);
     *     server.run();
     * });
     */
    loadRouters(routers) {
        routers.forEach(router => {
            if(router instanceof Router) {
                // Get Routes from Router
                const routes = router.routes;

                // Check if we have routes available
                if(routes.length === 0) {
                    Logger.warn(`[ROUTER] ${router.name} is initialized without routes!`);
                }

                // Loop over routes to initialize controllers
                routes.forEach(route => {
                    // Check if the controller extends our base controller
                    if(route.controller instanceof Controller) {
                        // Add all middlewares for every route
                        for (const mw of route.middlewares) {
                            this.#app.use(route.path, mw);
                        }

                        // Add the router from the controller
                        this.#app.use(route.path, route.controller.getRouter(router.name));
                    } else {
                        console.error('Error at line:', route);
                        throw new Error(`Class is not an instance of '@neobeach/core/Controller'!`);
                    }
                });

                Logger.info(`[SERVER] Loaded ${routes.length} router(s)`);
            } else {
                console.error('Error at line:', router);
                throw new Error(`Class is not an instance of '@neobeach/core/Router'!`);
            }
        });
    }

    /**
     * Includes/loads default express body parsers (json, text and urlencoded) with recommended config into the Express app
     *
     * @access public
     * @since 1.0.0
     * @author Glenn de Haan
     * @copyright MIT
     *
     * @see https://expressjs.com/en/api.html#express.json
     * @see https://expressjs.com/en/api.html#express.text
     * @see https://expressjs.com/en/api.html#express.urlencoded
     *
     * @example
     * const {Runtime, Server} = require('@neobeach/core');
     *
     * const server = new Server();
     *
     * Runtime(() => {
     *     server.includeDefaultBodyParsers();
     *     server.run();
     * });
     */
    includeDefaultBodyParsers() {
        this.#app.use(express.json());
        this.#app.use(express.text());
        this.#app.use(express.urlencoded({extended: false}));

        Logger.info(`[SERVER] Loaded default body parsers (json, text and urlencoded)`);
    }

    /**
     * Includes/loads default security headers with recommended config into the Express app
     *
     * @access public
     * @since 1.0.0
     * @author Glenn de Haan
     * @copyright MIT
     *
     * @see https://www.npmjs.com/package/helmet
     *
     * @example
     * const {Runtime, Server} = require('@neobeach/core');
     *
     * const server = new Server();
     *
     * Runtime(() => {
     *     server.includeDefaultSecurityHeaders();
     *     server.run();
     * });
     */
    includeDefaultSecurityHeaders() {
        const helmet = require('helmet');

        this.#app.use(helmet());

        Logger.info(`[SERVER] Loaded default security headers`);
    }

    /**
     * Includes/loads default CORS headers with recommended config into the Express app
     *
     * @access public
     * @since 1.0.0
     * @author Glenn de Haan
     * @copyright MIT
     *
     * @see https://www.npmjs.com/package/cors
     *
     * @param {String} origin - String with allowed origin URL's
     *
     * @example
     * const {Runtime, Server} = require('@neobeach/core');
     *
     * const server = new Server();
     *
     * Runtime(() => {
     *     server.includeDefaultCorsHeaders();
     *     server.run();
     * });
     */
    includeDefaultCorsHeaders(origin) {
        const cors = require('cors');

        this.#app.use(cors({
            origin
        }));

        Logger.info(`[SERVER] Loaded default CORS headers`);
    }

    /**
     * Includes/loads default compression (deflate, gzip) with recommended config into the Express app
     *
     * @access public
     * @since 1.0.0
     * @author Glenn de Haan
     * @copyright MIT
     *
     * @see https://www.npmjs.com/package/compression
     *
     * @example
     * const {Runtime, Server} = require('@neobeach/core');
     *
     * const server = new Server();
     *
     * Runtime(() => {
     *     server.includeDefaultCompression();
     *     server.run();
     * });
     */
    includeDefaultCompression() {
        const compression = require('compression');

        this.#app.use(compression({
            threshold: 0
        }));

        Logger.info(`[SERVER] Loaded default compression (deflate, gzip)`);
        Logger.warn(`[SERVER] !!! Please note: We recommend you to disable compression on production environments. Loadbalancers and reverse proxies are 9/10 times faster at doing this job... !!!`);
    }

    /**
     * Attach a Remix Framework build to our Express server
     *
     * @access public
     * @since 1.0.0
     * @author Glenn de Haan
     * @copyright MIT
     *
     * @see https://remix.run/docs/en/v1
     * @see https://remix.run/docs/en/v1/other-api/adapter
     *
     * @param {*} serverBuild - A Remix Server build
     *
     * @example
     * import * as serverBuild from "@remix-run/dev/server-build";
     *
     * const {Runtime, Server} = require('@neobeach/core');
     *
     * const server = new Server();
     *
     * Runtime(() => {
     *     server.loadRemixFramework(serverBuild);
     *     server.run();
     * });
     */
    loadRemixFramework(serverBuild) {
        const {createRequestHandler} = require('@remix-run/express');

        this.#app.use('/build', express.static(`${process.cwd()}/public/build`, { immutable: true, maxAge: '1y' }));
        this.#app.use(express.static(`${process.cwd()}/public/build`, { maxAge: '1h' }));
        this.#app.use(express.static(`${process.cwd()}/public`, { maxAge: '1h' }));

        this.#app.all('*', createRequestHandler({
            build: serverBuild,
            mode: process.env.NODE_ENV
        }));

        Logger.info(`[SERVER] Loaded Remix Server Build`);
    }
}

/**
 * Export the server class
 * @ignore
 */
module.exports = Server;
</code></pre>
        </article>
    </section>




    </div>

    <footer class="footer" id="footer">
      
    </footer>

    <script src="scripts/third-party/prettify.js"></script>
    <script src="scripts/third-party/lang-css.js"></script>
    <script type="text/javascript" src="scripts/misc.js"></script>

    <script>prettyPrint();</script>
    <script src="scripts/linenumber.js"></script>
    <script src="scripts/fix-code-block.js"></script>
    <script src="scripts/fix-navbar.js"></script>
    
      <script src="scripts/search.js"></script>
      <script src="scripts/third-party/fuse.js"></script>
      <script>
        var list = [{"title":"Config","link":"<a href=\"module-Config.html\">Config</a>"},{"title":"Logger","link":"<a href=\"module-Logger.html\">Logger</a>"},{"title":"Runtime","link":"<a href=\"module-Runtime.html\">Runtime</a>"},{"title":"Controller","link":"<a href=\"Controller.html\">Controller</a>"},{"title":"Controller#copy","link":"<a href=\"Controller.html#copy\">Controller &rtrif; copy</a>"},{"title":"Controller#delete","link":"<a href=\"Controller.html#delete\">Controller &rtrif; delete</a>"},{"title":"Controller#get","link":"<a href=\"Controller.html#get\">Controller &rtrif; get</a>"},{"title":"Controller#head","link":"<a href=\"Controller.html#head\">Controller &rtrif; head</a>"},{"title":"Controller#lock","link":"<a href=\"Controller.html#lock\">Controller &rtrif; lock</a>"},{"title":"Controller#options","link":"<a href=\"Controller.html#options\">Controller &rtrif; options</a>"},{"title":"Controller#patch","link":"<a href=\"Controller.html#patch\">Controller &rtrif; patch</a>"},{"title":"Controller#post","link":"<a href=\"Controller.html#post\">Controller &rtrif; post</a>"},{"title":"Controller#purge","link":"<a href=\"Controller.html#purge\">Controller &rtrif; purge</a>"},{"title":"Controller#put","link":"<a href=\"Controller.html#put\">Controller &rtrif; put</a>"},{"title":"Controller#unlock","link":"<a href=\"Controller.html#unlock\">Controller &rtrif; unlock</a>"},{"title":"Router","link":"<a href=\"Router.html\">Router</a>"},{"title":"Router#add","link":"<a href=\"Router.html#add\">Router &rtrif; add</a>"},{"title":"Server","link":"<a href=\"Server.html\">Server</a>"},{"title":"Server#includeDefaultBodyParsers","link":"<a href=\"Server.html#includeDefaultBodyParsers\">Server &rtrif; includeDefaultBodyParsers</a>"},{"title":"Server#includeDefaultCompression","link":"<a href=\"Server.html#includeDefaultCompression\">Server &rtrif; includeDefaultCompression</a>"},{"title":"Server#includeDefaultCorsHeaders","link":"<a href=\"Server.html#includeDefaultCorsHeaders\">Server &rtrif; includeDefaultCorsHeaders</a>"},{"title":"Server#includeDefaultSecurityHeaders","link":"<a href=\"Server.html#includeDefaultSecurityHeaders\">Server &rtrif; includeDefaultSecurityHeaders</a>"},{"title":"Server#loadMiddlewares","link":"<a href=\"Server.html#loadMiddlewares\">Server &rtrif; loadMiddlewares</a>"},{"title":"Server#loadRemixFramework","link":"<a href=\"Server.html#loadRemixFramework\">Server &rtrif; loadRemixFramework</a>"},{"title":"Server#loadRouters","link":"<a href=\"Server.html#loadRouters\">Server &rtrif; loadRouters</a>"},{"title":"Server#run","link":"<a href=\"Server.html#run\">Server &rtrif; run</a>"},{"title":"Logger","link":"<a href=\"global.html#Logger\">Logger</a>"}];
        var options = 
          setupSearch(list, options)
      </script>
    

    

    

    


  </body>

</html>
